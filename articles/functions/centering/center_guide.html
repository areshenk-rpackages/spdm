<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Centering covariance matrices • spdm</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../../../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../../../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../../../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../../../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../../../apple-touch-icon-60x60.png">
<script src="../../../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../../../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../../../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../../../deps/font-awesome-6.4.0/css/all.min.css" rel="stylesheet">
<link href="../../../deps/font-awesome-6.4.0/css/v4-shims.min.css" rel="stylesheet">
<script src="../../../deps/headroom-0.11.0/headroom.min.js"></script><script src="../../../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../../../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../../../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../../../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../../../deps/search-1.0.0/fuse.min.js"></script><script src="../../../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../../../pkgdown.js"></script><meta property="og:title" content="Centering covariance matrices">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-dark" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../../../index.html">spdm</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../../../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../../../articles/functions/centering/center_guide.html">Centering covariance matrices</a></li>
    <li><a class="dropdown-item" href="../../../articles/functions/interpolate/interp_guide.html">Interpolation of covariance matrices</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../../../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../../../logo.png" class="logo" alt=""><h1>Centering covariance matrices</h1>
                        <h4 data-toc-skip class="author">Corson N.
Areshenkoff</h4>
            
            <h4 data-toc-skip class="date">2024-10-01</h4>
      

      <div class="d-none name"><code>center_guide.Rmd</code></div>
    </div>

    
    
<p><strong>spdm</strong> includes a sample neuroimaging dataset
containing standardized BOLD timecourses from 5 subjects in each of 5
different conditions. This dataframe contains fields for Subject and
Condition, as well as a Data field containing a list of matrices
(n_timepoints x n_regions).</p>
<p>In a simple workflow, we might begin by computing the covariance
between each of these timecourses:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">bold</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">bold</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "Subject"   "Condition" "Data"</span></span>
<span></span>
<span><span class="co"># Note that it is almost always better to use some kind of regularized</span></span>
<span><span class="co"># covariance estimate, but we will use the sample covariance here for </span></span>
<span><span class="co"># illustration. For higher dimensional problems, it is likely that the </span></span>
<span><span class="co"># sample covariance will not be positive definite.</span></span>
<span><span class="va">covmats</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">bold</span><span class="op">$</span><span class="va">Data</span>, <span class="va">spd.estimate</span>, method <span class="op">=</span> <span class="st">"sample"</span><span class="op">)</span></span></code></pre></div>
<p>As a visualization aid, it is sometimes useful to create some kind of
low-dimensional representation of the data. Multidimensional scaling
will do in this case, and we’ll construct the distance matrix using the
pairwise geodesic distances between covariance matrix. At the moment,
<code>spd.dist</code> only computes distance between a single pair
(i.e. not in bulk), and so we’ll borrow from the <code>proxy</code>
packages in order to compute these efficiently:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">D_uncentered</span> <span class="op">&lt;-</span> <span class="fu">proxy</span><span class="fu">::</span><span class="fu">dist</span><span class="op">(</span><span class="va">covmats</span>, method <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span>,<span class="va">j</span><span class="op">)</span> </span>
<span>    <span class="fu"><a href="../../../reference/spd.dist.html">spd.dist</a></span><span class="op">(</span><span class="va">i</span>, <span class="va">j</span>, method <span class="op">=</span> <span class="st">"riemannian"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mds_uncentered</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cmdscale.html" class="external-link">cmdscale</a></span><span class="op">(</span><span class="va">D_uncentered</span><span class="op">)</span></span></code></pre></div>
<p>If we plot the embedded covariance matrices colored by subject we see
a phenomenon which has been widely replicated in the neuroimaging
literature: the clustering of covariance matrices within subjects:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Subject <span class="op">=</span> <span class="va">bold</span><span class="op">$</span><span class="va">Subject</span>,</span>
<span>                        x <span class="op">=</span> <span class="va">mds_uncentered</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,</span>
<span>                        y <span class="op">=</span> <span class="va">mds_uncentered</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">plot_data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, color <span class="op">=</span> <span class="va">Subject</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_point</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme_classic</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="center_guide_files/figure-html/unnamed-chunk-3-1.png" width="700" style="display: block; margin: auto;"></p>
<p>That is, functional connectivity measured in the same subject under
different task conditions is more similar than the same task condition
measured in different subjects (see Gratton et al. 2018). In fact, this
finding can be replicated under fairly extreme conditions; for example,
in Areshenkoff et al.  (2021) we find similar clustering in Macaques
under different doses of anesthesia. This is true even when comparing
nearly awake scans to those in which the animal is totally sedated.</p>
<p>The actual cause of this clustering is debated, but there are likely
two general reasons: 1) Functional connectivity is strongly constrained
by structural connectivity, which is variable across subjects; and 2)
Group average parcellations do not capture functional heterogeneity in
the cortex, so (for very fine parcellations) the same parcel of cortex
has slightly different functions across subjects.</p>
<p>Either way, the result is that actual task differences in functional
connectivity are buried in much larger static inter-subject differences.
A sensible strategy in this case would be to remove average subject
differences by “translating” the covariance matrices so that all subject
means align with a common reference point (generally, the grand mean).
This is quite simple with the <code><a href="../../../reference/spd.center.html">spd.center()</a></code> function, which
accepts a dataframe of observation information, a list of covariance
matrices, and various constraints defining the centering.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">covmats_centered</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../../reference/spd.center.html">spd.center</a></span><span class="op">(</span>d <span class="op">=</span> <span class="va">bold</span>, covmats <span class="op">=</span> <span class="va">covmats</span>, group_by <span class="op">=</span> <span class="st">"Subject"</span><span class="op">)</span></span></code></pre></div>
<p>In this case, we only need to align the subjects, and so specifying
<code>group_by = "Subject"</code> is enough.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">centered_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../../reference/spd.center.html">spd.center</a></span><span class="op">(</span>d <span class="op">=</span> <span class="va">bold</span>, covmats <span class="op">=</span> <span class="va">covmats</span>, group_by <span class="op">=</span> <span class="st">'Subject'</span><span class="op">)</span></span>
<span><span class="va">covmats_centered</span> <span class="op">&lt;-</span> <span class="va">centered_data</span><span class="op">$</span><span class="va">centered_covmats</span></span>
<span></span>
<span><span class="va">D_centered</span> <span class="op">&lt;-</span> <span class="fu">proxy</span><span class="fu">::</span><span class="fu">dist</span><span class="op">(</span><span class="va">covmats_centered</span>, method <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span>,<span class="va">j</span><span class="op">)</span> </span>
<span>    <span class="fu"><a href="../../../reference/spd.dist.html">spd.dist</a></span><span class="op">(</span><span class="va">i</span>, <span class="va">j</span>, method <span class="op">=</span> <span class="st">'riemannian'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mds_centered</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cmdscale.html" class="external-link">cmdscale</a></span><span class="op">(</span><span class="va">D_centered</span><span class="op">)</span></span></code></pre></div>
<p>And now the subject clustering is abolished.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Subject <span class="op">=</span> <span class="va">bold</span><span class="op">$</span><span class="va">Subject</span>,</span>
<span>                        x <span class="op">=</span> <span class="va">mds_centered</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,</span>
<span>                        y <span class="op">=</span> <span class="va">mds_centered</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">plot_data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, color <span class="op">=</span> <span class="va">Subject</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_point</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme_classic</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="center_guide_files/figure-html/unnamed-chunk-6-1.png" width="700" style="display: block; margin: auto;"></p>
<p>As a side note, many analyses are better conducted on the tangent
vectors around the grand mean (that is, the centered covariance matrices
projected onto the tangent space around the mean), and so
<code><a href="../../../reference/spd.center.html">spd.center()</a></code> returns both the centered covariance matrices,
and the target mean. The tangent vectors can then be easily computed by
log-mapping the centered observations:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tanvecs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">centered_data</span><span class="op">$</span><span class="va">centered_covmats</span>, <span class="va">spd.logmap</span>, </span>
<span>                  p <span class="op">=</span> <span class="va">centered_data</span><span class="op">$</span><span class="va">target_covariance</span><span class="op">)</span></span></code></pre></div>
<p>In some cases, the user is specifically interested in differences
relative to some reference condition (e.g. a resting state scan), and so
it may be preferable to center so that the reference scans for each
subject are aligned to the<br>
overall mean reference scan. For example, we might wish to align
condition “A” in this dataset. In that case, constraints can be
specified using the arguments <code>from_constraints</code> and
<code>to_constraints</code>. In this case, we want to center to the mean
of all observations in condition A, and so we set</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">from_constraints</span> <span class="op">&lt;-</span> <span class="st">"Condition == 'A'"</span></span>
<span><span class="va">to_constraints</span>   <span class="op">&lt;-</span> <span class="st">"Condition == 'A'"</span></span></code></pre></div>
<p>In the case of <code>to_constraints</code>, this condition is applied
within subjects, so that we take only those observations in condition A
when computing the subject means.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">centered_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../../reference/spd.center.html">spd.center</a></span><span class="op">(</span>d <span class="op">=</span> <span class="va">bold</span>, covmats <span class="op">=</span> <span class="va">covmats</span>, group_by <span class="op">=</span> <span class="st">"Subject"</span>,</span>
<span>                            from_constraints <span class="op">=</span> <span class="va">from_constraints</span>,</span>
<span>                            to_constraints <span class="op">=</span> <span class="va">to_constraints</span><span class="op">)</span></span>
<span><span class="va">covmats_centered</span> <span class="op">&lt;-</span> <span class="va">centered_data</span><span class="op">$</span><span class="va">centered_covmats</span></span>
<span></span>
<span><span class="va">D_centered</span> <span class="op">&lt;-</span> <span class="fu">proxy</span><span class="fu">::</span><span class="fu">dist</span><span class="op">(</span><span class="va">covmats_centered</span>, method <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span>,<span class="va">j</span><span class="op">)</span> </span>
<span>    <span class="fu"><a href="../../../reference/spd.dist.html">spd.dist</a></span><span class="op">(</span><span class="va">i</span>, <span class="va">j</span>, method <span class="op">=</span> <span class="st">'riemannian'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mds_centered</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cmdscale.html" class="external-link">cmdscale</a></span><span class="op">(</span><span class="va">D_centered</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>Subject <span class="op">=</span> <span class="va">bold</span><span class="op">$</span><span class="va">Subject</span>,</span>
<span>                        Condition <span class="op">=</span> <span class="va">bold</span><span class="op">$</span><span class="va">Condition</span>,</span>
<span>                        x <span class="op">=</span> <span class="va">mds_centered</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span>,</span>
<span>                        y <span class="op">=</span> <span class="va">mds_centered</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu">ggplot</span><span class="op">(</span><span class="va">plot_data</span>, <span class="fu">aes</span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span>, color <span class="op">=</span> <span class="va">Subject</span>, shape <span class="op">=</span> <span class="va">Condition</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu">geom_point</span><span class="op">(</span>size <span class="op">=</span> <span class="fl">3</span>, alpha <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span> <span class="op">+</span> <span class="fu">theme_classic</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="center_guide_files/figure-html/unnamed-chunk-9-1.png" width="700" style="display: block; margin: auto;"></p>
<p>where we now have a cluster of identical observations at (0,0) for
condition A, as these observations have been aligned across subjects.
Note that this kind of centering has not succeeded in eliminating
subject level clustering, since in addition to subject level
differences, subject-by-task <em>interactions</em> also tend to be much
larger than pure task effects.</p>
<div class="section level3">
<h3 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h3>
<p>Areshenkoff, C. N., Nashed, J. Y., Hutchison, R. M., Hutchison, M.,
Levy, R., Cook, D. J., … &amp; Gallivan, J. P. (2021). Muting, not
fragmentation, of functional brain networks under general anesthesia.
Neuroimage, 231, 117830.</p>
<p>Gratton, C., Laumann, T. O., Nielsen, A. N., Greene, D. J., Gordon,
E. M., Gilmore, A. W., … &amp; Petersen, S. E. (2018). Functional brain
networks are dominated by stable group and individual factors, not
cognitive or daily variation. Neuron, 98(2), 439-452.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by <a href="https://areshenk.github.io/" class="external-link"><img src="https://areshenk.github.io/about/sidebar/avatar.jpg" width="72"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
